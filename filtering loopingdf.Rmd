---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

```{r}
library(stringr)
library(tidyverse)
```


testing code
```{r}
mtcars
map_df(mtcars,mean)
```



```{r}
# Connect to the database
db <- src_sqlite("C:/Users/Caroline Wang/OneDrive/Duke/Criminal Recidivism/crim-recid-code/compas-analysis/compas.db", create = TRUE)

# List all the tables
table_names <- src_tbls(db)
table_names
```

```{r}
casearrest_df <- tbl(db,"casearrest")
charge_df <- tbl(db,"charge")
compas_df <- tbl(db,"compas")
jailhistory_df <-tbl(db,"jailhistory")
prisonhistory_df <-tbl(db,"prisonhistory")
people_df<-tbl(db,"people")
```

Creating a new df from a subset of compas_df, altering names of some columns
```{r}
df=select(compas_df,person_id,screening_date)
chargenew=select(charge_df,person_id,case_number,date_charge_filed)
peoplenew=rename(select(people_df, id, dob), person_id=id)

df<-df%>%
          left_join(chargenew, by="person_id")%>%
          left_join(peoplenew, by="person_id")%>%
          as_data_frame()

summarise(df,n())
#loopdf=left_join(loopdf, chargenew, by="person_id")
#consider adding the variables, charge_number and charge
#will need charge number later so I can do dispositions
```
Rows in df: person_id, screening_date, case_number, date_charge_filed, dob


filtering criteria
1) remove people with compas score screening date>30 days from any crime date 
```{r}
nrow(df)
df$screening_date=as.Date(df$screening_date)
df$date_charge_filed=as.Date(df$date_charge_filed)

compas_30<-df%>%
        mutate(days_from_compas=(screening_date-date_charge_filed))%>%
        mutate(within_30=(days_from_compas<=30))%>%
        group_by(person_id)%>%
           summarize(valid_screen_date=(sum(within_30)>0)) #Boolean, number of cases within 30 days for each person is >0


df1<-df%>%
      left_join(compas_30, by="person_id")%>%
      filter(valid_screen_date==T)

nrow(df1)


```

2) check if any people have charge date before dob
```{r}
nrow(df)
df2<-filter(df, !((date_charge_filed>dob) | is.na(date_charge_filed) | is.na(dob)))
df2 #the cases that were removed; all have dob=date_charge_filed

df<-filter(df, (date_charge_filed>dob) | is.na(date_charge_filed) | is.na(dob))
nrow(df)

```


3) check number of duplicate cases (independent of person IDs)
```{r}
numcases<-nrow(distinct(select(df,case_number))) #80085
loopdf<-as_data_frame(distinct(select(df,person_id,case_number)))
checkdups<-nrow(loopdf) #80702
#discrepancy of ~650, not worth fixing 
numcases
checkdups
```


Write df to working directory
```{r}
write.csv(loopdf, "loopdf.csv") 
```

